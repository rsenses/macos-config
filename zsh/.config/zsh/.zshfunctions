# ssh
ss () {
    local ssh_config="$HOME/.ssh/config"
    if [[ ! -f $ssh_config ]]; then
        printf 'ss: no encuentro %s\n' "$ssh_config" >&2
        return 1
    fi

    if ! command -v fzf >/dev/null 2>&1; then
        printf 'ss: fzf no está instalado\n' >&2
        return 1
    fi

    local server
    server=$(grep -E '^Host ' "$ssh_config" | awk '{print $2}' | grep -vE '(^\*|!|[*?])' | fzf)
    if [[ -n $server ]]; then
        ssh "$server"
    fi
}

# resize images
resize() {
    if [[ $# -lt 3 ]]; then
        echo "Uso: resize <imagen> <ancho_resize_px> <tamaño_final (ej. 250x250 o 250x300)> [color_fondo] (en hexadecimal o none para transparente, por defecto blanco)"
        echo "Ejemplo: resize logo.png 200 250x250 white"
        return 1
    fi

    local input="$1"
    local resize_width="$2"
    local final_size="$3"
    local bg="${4:-white}"  # fondo blanco por defecto

    # Obtener nombre base y extensión
    local base="${input%.*}"
    local ext="${input##*.}"

    # Generar nombre de salida: nombre-<resize>-<final>.ext
    local output="${base}-${resize_width}.${ext}"

    magick "$input" \
        -strip -colorspace sRGB \
        -resize "${resize_width}x" \
        -filter Lanczos \
        -unsharp 0x1 \
        -background "$bg" \
        -gravity center \
        -extent "$final_size" \
        "$output"

    echo "✅ Imagen generada: $output"
}

# Yazi
y() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
    yazi "$@" --cwd-file="$tmp"
    IFS= read -r -d '' cwd < "$tmp"
    [ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
    rm -f -- "$tmp"
}

unlock_bw_if_locked() {
    if [[ -z $BW_SESSION ]] ; then
        >&2 echo 'bw locked - unlocking into a new session'
        export BW_SESSION="$(bw unlock --raw)"
    fi
}

bw-env() {
    unlock_bw_if_locked
    local search="$@"
    keys_string=$(bw get username $search)
    if [[ $? != 0 ]] ; then
        return
    fi
    values_string=$(bw get password $search)
    read -A keys <<< "$keys_string"
    read -A values <<< "$values_string"

    # If we store "AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY" in the username field
    # and "secret1 secret2" in the password field, we'll map them accordingly.
    # If there are fewer secrets than usernames (space separated), then we'll
    # use the last value for the rest of the secrets mapped to usernames.
    # For example: "GITHUB_TOKEN GITHUB_AUTH_TOKEN" with a password of "foo" will
    # set both environment variables to "foo".
    for ((i = 1 ; i <= $#keys ; i++)) ; do
        if [[ "$values[$i]" != "" ]] ; then
            last_value=$values[$i]
        fi
        export $keys[$i]=$last_value
        >&2 echo "Loaded $keys[$i]"
    done
}
